<script type="text/template" id="messagesItemTemplate">
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                Conversation with <% if (_.getUser()._id.$id == lastMessage.by_user._id.$id) { %>
                    <%=lastMessage.to_user.username%>
                <% } else { %>
                    <%=lastMessage.by_user.username%>
                <% } %> · <%=messageCount%> messages
            </h3>
        </div>
        <div class="panel-body">
            <ul class="list-group">
                <% _.each(messages, function (message, key) { %>
                <li class="list-group-item <% if (_.getUser()._id.$id == message.by_user._id.$id) { %>list-group-item-info<% } %>">
                    <h4 class="list-group-item-heading">
                        <%=message.by_user.username%> ·
                        <%=new Date(message.created.sec*1000).toLocaleString()%>
                    </h4>
                    <%=_.nl2br(message.message)%>
                </li>
                <% }) %>
                <li class="list-group-item list-group-item-success">
                    <form role="form">
                        <div class="form-group">
                            <textarea class="form-control" rows="6"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">Send Message</button>
                    </form>
                </li>
            </ul>
        </div>
    </div>
</script>